'use strict';

/////////////////////////////////////////////////////Draggable/////////////////////////////////////////////////////

// Make the DIV element draggable:
dragElement(document.querySelector('.window'));

function dragElement(elmnt) {
  let pos1 = 0,
    pos2 = 0,
    pos3 = 0,
    pos4 = 0;
  if (document.getElementById(elmnt.id + 'header')) {
    // if present, the header is where you move the DIV from:
    document.getElementById(elmnt.id + 'header').onmousedown = dragMouseDown;
  } else {
    // otherwise, move the DIV from anywhere inside the DIV:
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = elmnt.offsetTop - pos2 + 'px';
    elmnt.style.left = elmnt.offsetLeft - pos1 + 'px';
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

/////////////////////////////////////////////////////Command Line/////////////////////////////////////////////////////

const cli = document.querySelector('.window__body');
const inputLine = document.querySelector('.input-line');

const displayArray = (arr) => {
  return arr.reduce((acc, el) => acc + el);
};

const clearCurrentLine = () => {
  inputLine.textContent = '';
  input = [];
};

const deleteCharacter = (arr) => {
  arr.pop();
  arr.length >= 1
    ? (inputLine.textContent = displayArray(input))
    : (inputLine.textContent = '');
};

const addCharacter = (arr, obj) => {
  arr.push(obj.key);
  inputLine.textContent = displayArray(arr);
};

const latestHistory = (arr) => arr[arr.length - 1];
const formatInput = (str) => str.trimStart().trimEnd();
const addLine = (str) => {
  const p = document.createElement('p');
  p.textContent = str;
  cli.insertBefore(p, inputLine);
};

let history = [];
let input = [];

const windowEventHandler = (e) => {
  if (e.key === 'Enter') {
    history.push(formatInput(inputLine.textContent));
    addLine(latestHistory(history));
    parseCommand(history);
    clearCurrentLine();
  } else if (e.key === 'Backspace') {
    deleteCharacter(input);
  } else if (
    (e.keyCode >= 65 && e.keyCode <= 90) ||
    e.keyCode === 32 ||
    e.keyCode === 189
  ) {
    addCharacter(input, e);
  }
};

document.addEventListener('keydown', windowEventHandler);

/////////////////////////////////////////////////////Commands/////////////////////////////////////////////////////

const errorMsg = "Error. Command doesn't exist";

const displayText = (user, str) => {
  const userElement = document.createElement('p');
  const textElement = document.createElement('p');
  const br = document.createElement('br');
  userElement.style.display = 'inline';
  userElement.style.color = '#29cd3f';
  textElement.style.display = 'inline';
  userElement.textContent = user + ' ';
  textElement.textContent = str;
  cli.insertBefore(userElement, inputLine);
  cli.insertBefore(textElement, inputLine);
  cli.insertBefore(br, inputLine);
};

const parseCommand = (arr) => {
  const currentCommand = latestHistory(arr).split(' ');
  console.log(currentCommand);

  if (currentCommand[0] === 'help') {
    displayText('You typed in help');
  } else {
    displayText(errorMsg);
  }
};

//hoist all functions and put them on the top

/////////////////////////////////////////////////////Welcome Message/////////////////////////////////////////////////////
const currentuser = 'user@hendriktreuner.com';

const welcomeMsg =
  "Hello. I'm Hendrik Treuner. I am a self taught Front End Developer currently living in Berlin, Germany.";
const helpMsg = "For a list of commands type: 'help'";
displayText(currentuser, welcomeMsg);
displayText(currentuser, helpMsg);

/////////////////////////////////////////////////////Cursor/////////////////////////////////////////////////////
const cursorELement = document.querySelector('.cursor');

let cursor = true;

const cursorBlink = () => {
  if (cursor) {
    cursorELement.textContent = '';
    cursor = false;
  } else {
    cursorELement.textContent = '|';
    cursor = true;
  }
};

setInterval(cursorBlink, 500);
